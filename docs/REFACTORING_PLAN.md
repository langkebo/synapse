# Synapse Rust 项目重构计划书

> **版本**：1.0.0  
> **编制日期**：2026-01-28  
> **状态**：草稿  
> **参考标准**：[Synapse 官方文档](https://element-hq.github.io/synapse/latest/)、[Matrix 规范](https://spec.matrix.org/)

---

## 一、项目背景与现状分析

### 1.1 项目背景

Synapse Rust 项目旨在使用 Rust 语言重新实现 Matrix 协议的开源 homeserver——Synapse，以获得更好的性能、更低的内存占用以及更强的安全性。原 Synapse Python 实现虽然在功能上非常完善，但在高并发场景下存在性能瓶颈。通过使用 Rust，我们期望在保持功能兼容性的同时，显著提升系统的整体性能表现。

Matrix 协议是一个去中心化即时通讯协议，支持端到端加密、房间管理、联邦通信等核心功能。Synapse 作为最广泛使用的 Matrix homeserver 实现之一，需要完全遵循 Matrix 规范，确保与其他 Matrix 客户端和服务器的互操作性。

### 1.2 当前项目状态

由于执行 `git clean -fd` 命令时未正确配置 gitignore 文件，导致源代码目录被意外删除。当前项目状态如下：

数据库层面已经完成恢复，包括用户表、设备表、房间表、事件表等核心数据表均已按照设计 schema 创建完成。数据库用户 synapse_user 已创建并授予必要的权限，可以正常访问 synapse_db 数据库。然而，源代码层面需要完全重建，包括所有 Rust 模块、实现代码、测试代码等。

项目配置文件 Cargo.toml 仍然存在，其中定义了项目的依赖关系、编译选项和特性开关。基础目录结构也得以保留，这为代码重建提供了一定的参考框架。

### 1.3 事故原因分析

本次事故的直接原因是执行 `git clean -fd` 命令时，该命令会强制删除所有未被 Git 跟踪的文件和目录。由于源代码目录尚未被 Git 正确跟踪管理，导致整个 src 目录被删除。这暴露出项目在版本控制管理方面的不足，未能及时将代码纳入版本控制体系。

为防止类似事故再次发生，项目将建立严格的代码提交策略，要求每日至少提交一次代码到远程仓库，同时完善 .gitignore 文件配置，确保关键目录和文件不被意外删除。

---

## 二、重构目标与范围

### 2.1 核心目标

本次重构的核心目标是在保持与 Matrix 规范完全兼容的前提下，构建一个高性能、高可靠、易维护的 Rust 实现。具体而言，项目的核心目标包含以下几个维度：

**性能提升目标**：通过 Rust 的内存安全特性和零成本抽象，实现同步延迟从基准值降至 5ms 以内，内存占用控制在 200MB 以下，支持 500K 并发用户连接，API 端到端响应时间控制在 10ms 以内。这些指标将为后续的性能优化提供明确的基准线和改进方向。

**功能完整性目标**：确保所有 Matrix Client API、SAdmin API、Media API 和 Federation API 端点完全按照规范实现。同时，在核心功能稳定的基础上，逐步实现 E2EE 端到端加密支持，包括设备密钥管理、房间密钥交换、消息加密解密等功能。

**代码质量目标**：建立完善的代码规范和审查流程，确保代码库的可读性、可维护性和可扩展性。单元测试覆盖率应达到 80% 以上，关键路径的集成测试覆盖率应达到 60% 以上，所有 API 端点必须有对应的功能测试。

### 2.2 重构范围

本次重构覆盖项目的所有核心模块，按照依赖关系和实现优先级，分为三个阶段逐步推进：

**第一阶段（基础模块）**：实现 common 模块和 storage 模块。common 模块包含错误类型定义、公共数据结构、配置解析和加密工具函数，是整个项目的基础设施层。storage 模块负责所有数据库操作，包括用户、设备、令牌、房间、成员和事件等实体的持久化。

**第二阶段（服务层）**：在 storage 模块基础上，实现 auth 认证模块和 services 服务层。auth 模块负责用户注册、登录、令牌生成和验证等安全相关功能。services 模块包含业务逻辑层，实现注册服务、房间服务、同步服务和媒体服务等核心业务功能。

**第三阶段（Web 层）**：实现 web 路由层和中间件。web 层负责处理所有 HTTP 请求，包括 Client API、Admin API、Media API 和 Federation API 的路由和处理函数。中间件提供日志记录、跨域访问控制、认证授权、请求限流等横切关注点的支持。

### 2.3 预期成果

重构完成后，项目将交付以下成果物：完整的 Rust 源代码、数据库 schema 脚本、配置文件模板、Docker 部署文件、API 文档、测试报告以及部署运维手册。所有代码将通过 Git 进行版本控制，并托管在 GitHub 仓库中。

---

## 三、重构实施计划

### 3.1 阶段一：基础模块实现

#### 3.1.1 common 模块实现

common 模块是整个项目的基础，需要首先完成。该模块包含四个子模块：error 模块定义统一的错误类型和错误处理方式；types 模块定义项目中使用的公共数据结构；config 模块负责从配置文件和环境变量中读取配置参数；crypto 模块提供密码哈希、加密解密、随机数生成等密码学工具函数。

error 模块的设计采用 std::error::Error trait 体系，定义 ApiError 结构体作为统一的错误类型，包含错误码、错误消息和 HTTP 状态码。所有的业务错误和系统错误都应转换为 ApiError 向上层返回，确保错误处理的统一性和可追溯性。

config 模块使用 config crate 实现配置文件的解析，支持 YAML 格式的配置文件。配置项包括服务器名称、监听地址、数据库连接信息、缓存配置、JWT 密钥和过期时间等。配置参数支持从环境变量覆盖，以适应不同部署环境的需求。

crypto 模块提供四个核心功能：password_hash 函数使用 argon2 算法对用户密码进行哈希处理，存储安全的密码摘要；verify_password 函数验证密码与哈希值是否匹配；generate_token 函数生成安全的随机令牌；hash_data 和 verify_data 函数提供 HMAC-SHA256 签名和验证功能。

#### 3.1.2 storage 模块实现

storage 模块负责所有数据持久化操作，使用 SQLx 作为数据库访问层，充分利用其编译时检查和异步支持特性。该模块包含 user、device、token、room、membership 和 event 六个子模块，每个子模块对应一个数据库实体的存储操作。

UserStorage 结构体封装用户实体的所有数据库操作，包括 create_user 创建新用户、get_user_by_id 根据用户 ID 查询用户、get_user_by_username 根据用户名查询用户、update_user 更新用户信息、delete_user 删除用户、list_users 列出所有用户等功能。所有查询操作都应支持缓存，以减少数据库压力并提高响应速度。

DeviceStorage 结构体封装设备实体的存储操作，包括 create_device 创建设备、get_device 查询设备、get_user_devices 查询用户的设备列表、update_device 更新设备信息、delete_device 删除设备等功能。设备表与用户表之间存在外键关联，在删除用户时应级联删除其所有设备。

TokenStorage 结构体封装访问令牌和刷新令牌的存储操作，包括 create_token 创建令牌、validate_token 验证令牌、revoke_token 撤销令牌、revoke_user_tokens 撤销用户的所有令牌等功能。令牌存储需要支持过期时间管理，定期清理过期令牌以释放存储空间。

RoomStorage 结构体封装房间实体的存储操作，包括 create_room 创建房间、get_room 查询房间、update_room 更新房间、delete_room 删除房间、list_rooms 列出房间等功能。房间创建时需要生成唯一的 room_id，使用本地生成的算法确保 ID 的唯一性和可排序性。

EventStorage 结构体封装事件实体的存储操作，包括 create_event 创建事件、get_event 查询事件、get_room_events 查询房间事件列表、get_state_events 查询状态事件、get_missing_events 获取缺失事件等功能。事件存储需要支持分页查询和深度排序，以支持联邦同步和消息历史检索。

### 3.2 阶段二：认证与服务层实现

#### 3.2.1 auth 模块实现

auth 模块是项目的安全核心，负责用户的身份认证和访问控制。该模块基于 JWT（JSON Web Token）实现无状态的令牌认证机制，结合缓存系统实现高性能的令牌验证。

AuthService 结构体是认证模块的核心，提供三个主要方法：register 方法处理用户注册请求，验证用户名唯一性，对密码进行哈希处理，创建用户记录、设备记录和初始令牌；login 方法处理用户登录请求，验证用户凭据，更新设备最后活跃时间，生成新的访问令牌和刷新令牌；logout 方法处理用户登出请求，撤销当前的访问令牌和刷新令牌。

令牌生成使用 jsonwebtoken crate，Claims 结构体包含用户 ID、管理员标识、设备 ID、过期时间等信息。访问令牌默认有效期为 24 小时，刷新令牌默认有效期为 7 天。令牌签名使用 HS256 算法，密钥从配置文件读取。

令牌验证流程包括解析 JWT 令牌、验证签名有效性、检查令牌是否过期、检查令牌是否在撤销列表中、获取关联的用户和设备信息等步骤。为提高验证性能，已验证的令牌会缓存在 Redis 中，设置与令牌剩余有效期一致的 TTL。

#### 3.2.2 services 模块实现

services 模块在 storage 和 auth 模块基础上封装业务逻辑，提供更高层次的抽象接口。该模块包含 registration_service、room_service、sync_service 和 media_service 四个子模块。

RegistrationService 处理用户注册相关的业务逻辑，包括注册请求验证、用户名可用性检查、用户创建、欢迎消息发送等功能。注册流程需要检查用户名是否符合 Matrix 规范（以 @ 开头，格式为 @localname:servername），检查用户名是否已被占用，创建用户时生成完整的 user_id。

RoomService 处理房间相关的业务逻辑，包括创建房间、房间配置、房间成员管理、房间消息发送等功能。创建房间时需要生成唯一的 room_id，设置房间创始成员，创建房间初始状态事件。房间成员管理支持加入、离开、邀请、踢出、封禁等操作，每种操作都需要创建相应的事件并更新成员表。

SyncService 处理同步相关的业务逻辑，负责管理用户的同步状态和事件流。Matrix 的同步机制基于事件 ID 的增量获取，客户端通过 since 参数指定上次同步的位置，服务端返回该位置之后的所有新事件。同步服务需要维护每个用户的同步状态，支持多个设备同时同步。

MediaService 处理媒体文件相关的业务逻辑，包括媒体上传、媒体检索、缩略图生成、媒体元数据管理等功能。媒体文件存储在本地文件系统中，通过 media_id 进行索引，URL 格式为 /_matrix/media/r0/download/servername/media_id。媒体服务需要验证文件类型和大小限制，防止恶意文件上传。

### 3.3 阶段三：Web 层实现

#### 3.3.1 路由层实现

Web 路由层使用 Axum 框架构建，遵循 RESTful 设计风格。所有 API 端点按照功能划分为四个模块：client 模块处理 Client-Server API，admin 模块处理 Admin API，media 模块处理 Media API，federation 模块处理 Federation API。

Client API 路由包括：版本检查端点 `GET /_matrix/client/versions` 返回支持的客户端 API 版本；注册端点 `POST /_matrix/client/r0/register` 处理新用户注册；登录端点 `POST /_matrix/client/r0/login` 处理用户登录；同步端点 `GET /_matrix/client/r0/sync` 返回自上次同步以来的新事件；房间消息端点 `POST /_matrix/client/r0/rooms/:room_id/send/:event_type` 发送房间消息；房间创建端点 `POST /_matrix/client/r0/createRoom` 创建新房间。

Admin API 路由包括：服务器版本端点 `GET //_synapse/admin/v1/server_version` 返回服务器版本信息；用户管理端点支持获取、创建、更新、删除用户；房间管理端点支持获取和删除房间；统计端点返回服务器运行统计数据。

Media API 路由包括：上传端点 `POST /_matrix/media/r0/upload` 上传媒体文件；下载端点 `GET /_matrix/media/r0/download/:server_name/:media_id` 下载媒体文件；预览端点 `GET /_matrix/media/r0/preview/:url` 预览链接内容。

Federation API 路由包括：版本端点 `GET /_matrix/federation/v1/version` 返回联邦协议版本；事务端点 `PUT /_matrix/federation/v1/send/:txn_id` 接收远程服务器发送的事务；密钥端点处理密钥交换和声明；房间状态端点处理联邦房间状态同步。

#### 3.3.2 中间件实现

中间件提供横切关注点的统一处理，包括日志记录、跨域访问控制、认证授权、请求限流等功能。

Logging 中间件使用 tracing crate 实现结构化日志记录，记录每个请求的起始时间、结束时间、请求方法、请求路径、响应状态码、客户端 IP 等信息。日志输出支持控制台和文件两种方式，生产环境建议使用文件输出并配置日志轮转。

Cors 中间件处理跨域请求，根据配置的允许来源、允许方法、允许头信息等，动态设置响应的 CORS 头。对于简单请求直接返回 CORS 头，对于预检请求（OPTIONS 方法）返回 204 响应。

Auth 中间件从请求头中提取 Bearer Token，调用 auth 模块的令牌验证方法，验证通过后将用户信息附加到请求扩展中，供后续的处理函数使用。认证失败的请求返回 401 状态码和错误信息。

RateLimit 中间件实现请求限流功能，防止恶意请求对服务器造成压力。基于滑动窗口算法统计每个 IP 或每个用户的请求频率，超过阈值时返回 429 状态码。限流配置支持按端点类型设置不同的阈值。

### 3.4 时间计划

重构工作按照三个阶段推进，预计总工期为两周。第一阶段基础模块实现预计需要 8 小时，包括 common 模块 2 小时、storage 模块 4 小时、cache 模块 2 小时。第二阶段认证与服务层实现预计需要 10 小时，包括 auth 模块 3 小时、services 模块 7 小时。第三阶段 Web 层实现预计需要 8 小时，包括路由层 4 小时、中间件 2 小时、服务器入口 2 小时。

每个阶段的代码实现完成后，需要进行编译检查、单元测试、集成测试，确保代码质量符合要求。整个项目重建完成后，进行系统级的端到端测试，验证所有 API 端点的功能正确性。

---

## 四、资源需求与分配

### 4.1 人力资源配置

项目重构需要投入的主要人力资源包括：技术负责人一名，负责整体架构设计、技术决策和代码审查；后端开发工程师一名，负责核心模块开发和单元测试；测试工程师一名，负责测试用例设计和系统测试。考虑到项目规模和时间限制，建议由同一人兼任技术负责人和开发工程师，测试工作可与开发并行进行。

### 4.2 开发环境配置

开发环境需要准备以下软硬件资源：操作系统推荐使用 Linux 或 macOS，Windows 环境下建议使用 WSL2；Rust 工具链版本不低于 1.75，需要安装 cargo、rustc、rustfmt、clippy 等工具；数据库环境使用 Docker 容器运行 PostgreSQL 15；缓存环境使用 Docker 容器运行 Redis 7；代码编辑器推荐使用 VS Code 或 RustRover，安装 rust-analyzer 插件以获得代码补全和错误提示功能。

### 4.3 测试环境配置

测试环境需要准备独立的数据库实例和缓存实例，避免与开发环境数据混淆。测试数据库应包含足够的测试数据，覆盖各种边界情况和异常场景。性能测试需要准备模拟数据生成工具，能够生成大量用户、房间、事件数据以进行压力测试。

---

## 五、风险管理

### 5.1 技术风险

技术风险主要来源于对 Rust 语言和异步编程模型的不熟悉。应对措施包括：提前学习 Rust 异步编程相关知识，参考优秀的开源项目实现，遇到问题及时查阅文档和寻求帮助。在开发过程中优先实现核心功能的最小可行版本，复杂功能分步骤实现。

### 5.2 进度风险

进度风险主要来源于意外情况导致的工期延误。应对措施包括：建立每日进度汇报机制，及时发现和解决阻塞问题；预留一定的缓冲时间应对不可预见的问题；对于非关键路径的功能，可以根据实际情况调整优先级。

### 5.3 质量风险

质量风险主要来源于代码缺陷和功能缺失。应对措施包括：建立代码审查机制，所有代码合并前必须经过审查；编写完整的测试用例，确保测试覆盖所有代码路径；完成代码实现后进行全面的功能测试和性能测试。

---

## 六、验收标准

### 6.1 功能验收

所有 API 端点必须按照 Matrix 规范实现，响应格式符合规范要求。客户端使用主流 Matrix 客户端（如 Element）能够正常注册、登录、创建房间、发送消息。联邦通信能够与其他 Matrix 服务器正常交换事件。

### 6.2 性能验收

系统启动时间不超过 5 秒，API 响应时间（P50）不超过 10 毫秒，内存占用稳定后不超过 300 兆字节，支持 1000 并发用户同时在线。

### 6.3 代码质量验收

代码编译无警告，clippy 检查通过，单元测试覆盖率不低于 80%，集成测试覆盖率不低于 60%，代码可读性好，有适当的注释说明。

---

## 七、附录

### 7.1 参考资料

本重构计划参考了以下资料：Synapse 官方文档提供了 Synapse 的架构设计和实现细节；Matrix 规范定义了 Matrix 协议的详细行为；Axum 框架文档提供了 Web 开发的最佳实践；SQLx 文档提供了数据库访问的指导方针。

### 7.2 术语说明

本文档中使用的专业术语说明如下：Homeserver 是 Matrix 网络中的服务器节点，负责存储用户数据和转发消息；Room 是 Matrix 中的群聊空间，支持多人即时通讯；Event 是 Matrix 中的基本消息单元，所有操作都表示为事件；Federation 是 Matrix 服务器之间的通信机制，实现去中心化的消息传递；E2EE 是端到端加密，确保消息只能被通信双方解密阅读。

---

**编制人**：  
**审核人**：  
**批准人**：  
