# 架构设计文档

> **版本**：1.0.0  
> **创建日期**：2026-01-28  
> **项目状态**：开发中  
> **参考文档**：[Synapse 官方文档](https://element-hq.github.io/synapse/latest/)、[Matrix 规范](https://spec.matrix.org/)

---

## 一、系统架构概述

### 1.1 架构设计原则

Synapse Rust 项目采用分层架构设计，遵循以下原则：

1. **关注点分离**：每一层专注于特定的职责，降低耦合度
2. **依赖倒置**：高层模块不依赖低层模块，都依赖于抽象
3. **单一职责**：每个模块只负责一个功能领域
4. **开闭原则**：对扩展开放，对修改关闭
5. **接口隔离**：使用 trait 定义清晰的接口边界

### 1.2 架构目标

- **高性能**：利用 Rust 的零成本抽象和异步编程特性
- **高可用**：支持水平扩展和故障恢复
- **可维护性**：清晰的模块划分和代码组织
- **可扩展性**：支持插件和扩展功能
- **安全性**：内存安全、类型安全、并发安全

---

## 二、分层架构

### 2.1 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                    Presentation Layer                           │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────┐  │
│  │  Client API     │  │ Admin API      │  │  Media API          │  │
│  │  (Axum Router)  │  │  (Axum Router)  │  │  (Axum Router)      │  │
│  └────────┬────────┘  └────────┬────────┘  └──────────┬──────────┘  │
└─────────────────────────────────────────────────────────────────────┘
                                │
                    ┌──────────┴──────────┐
                    │   Middleware Layer  │
                    │  ┌────────────────┐ │
                    │  │ Authentication │ │
                    │  │ Logging        │ │
                    │  │ CORS           │ │
                    │  │ Rate Limiting  │ │
                    │  └────────────────┘ │
                    └─────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Service Layer                                │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ │
│  │ Registration │ │    Room      │ │    Sync      │ │   Media    │ │
│  │   Service    │ │   Service    │ │   Service    │ │  Service   │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│  │   Friend     │ │  PrivateChat │ │    Voice     │               │
│  │   Service    │ │   Service    │ │   Service    │               │
│  └──────────────┘ └──────────────┘ └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Cache Layer                                  │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    Cache Manager                             │   │
│  │  ┌─────────────────┐           ┌─────────────────────────┐  │   │
│  │  │  Local Cache    │           │    Redis Cache          │  │   │
│  │  │  (Moka)         │           │    (Redis + R2D2)       │  │   │
│  │  │  LRU, In-Memory │           │    Distributed          │  │   │
│  │  └─────────────────┘           └─────────────────────────┘  │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       Storage Layer                                  │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ │
│  │  User        │ │  Device      │ │   Room       │ │   Event    │ │
│  │  Storage     │ │  Storage     │ │   Storage    │ │   Storage  │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ └──────────────┘ │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐               │
│  │  Token       │ │ Membership   │ │ Presence     │               │
│  │  Storage     │ │  Storage     │ │   Storage     │               │
│  └──────────────┘ └──────────────┘ └──────────────┘               │
└─────────────────────────────────────────────────────────────────────┘
                                │
                    ┌─────────┴─────────┐
                    │   SQLx (PostgreSQL)│
                    └─────────────────────┘
```

### 2.2 层次说明

#### 2.2.1 表现层 (Presentation Layer)

表现层负责处理 HTTP 请求和响应，使用 Axum 框架实现。

**职责**：
- 接收和解析 HTTP 请求
- 验证请求参数
- 调用服务层处理业务逻辑
- 格式化并返回 HTTP 响应
- 处理错误和异常

**组件**：
- **Client API Router**：处理 Matrix 客户端 API 请求
- **Admin API Router**：处理管理员 API 请求
- **Media API Router**：处理媒体文件上传和下载

#### 2.2.2 中间件层 (Middleware Layer)

中间件层提供横切关注点的功能，如认证、日志、CORS 等。

**职责**：
- 用户认证和授权
- 请求日志记录
- CORS 处理
- 速率限制
- 请求追踪

**组件**：
- **Authentication Middleware**：验证 JWT 令牌
- **Logging Middleware**：记录请求和响应
- **CORS Middleware**：处理跨域请求
- **Rate Limiting Middleware**：限制请求频率

#### 2.2.3 服务层 (Service Layer)

服务层封装业务逻辑，协调存储层和缓存层的操作。

**职责**：
- 实现业务逻辑
- 数据验证和转换
- 事务管理
- 调用存储层和缓存层
- 处理业务异常

**组件**：
- **Registration Service**：用户注册和登录
- **Room Service**：房间管理
- **Sync Service**：事件同步
- **Media Service**：媒体文件管理
- **Friend Service**：好友管理
- **Private Chat Service**：私聊管理
- **Voice Service**：语音消息管理

#### 2.2.4 缓存层 (Cache Layer)

缓存层提供两级缓存机制，提升访问性能。

**职责**：
- 管理本地缓存（Moka）
- 管理分布式缓存（Redis）
- 缓存失效策略
- 缓存预热

**组件**：
- **Local Cache**：基于 Moka 的 LRU 缓存
- **Redis Cache**：基于 Redis 的分布式缓存

#### 2.2.5 存储层 (Storage Layer)

存储层负责所有数据库操作，使用 SQLx 进行类型安全的 SQL 查询。

**职责**：
- 数据库连接管理
- SQL 查询执行
- 数据持久化
- 事务管理

**组件**：
- **User Storage**：用户数据操作
- **Device Storage**：设备数据操作
- **Room Storage**：房间数据操作
- **Event Storage**：事件数据操作
- **Token Storage**：令牌数据操作
- **Membership Storage**：成员关系数据操作
- **Presence Storage**：在线状态数据操作

---

## 三、模块依赖关系

### 3.1 依赖图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        web/                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   routes/    │  │ middleware/  │  │   handlers/  │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
└─────────┼──────────────────┼──────────────────┼─────────────────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      services/                                   │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │ registration │  │     room     │  │     sync     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │    friend    │  │ private_chat │  │    voice     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
└─────────┼──────────────────┼──────────────────┼─────────────────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       cache/                                      │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    CacheManager                             │   │
│  └─────────────────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       storage/                                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │    user/     │  │   device/    │  │    room/     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │    token/    │  │ membership/  │  │   event/     │         │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘         │
└─────────┼──────────────────┼──────────────────┼─────────────────────┘
          │                  │                  │
          └──────────────────┼──────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       common/                                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐         │
│  │   error.rs   │  │  config.rs   │  │   crypto.rs  │         │
│  └──────────────┘  └──────────────┘  └──────────────┘         │
└─────────────────────────────────────────────────────────────────────┘
```

### 3.2 依赖规则

1. **表现层** → **服务层**：表现层调用服务层
2. **服务层** → **缓存层**：服务层调用缓存层
3. **服务层** → **存储层**：服务层调用存储层
4. **存储层** → **通用模块**：存储层使用通用模块
5. **所有层** → **通用模块**：所有层使用通用模块的错误、配置等

---

## 四、数据流设计

### 4.1 用户注册流程

```
Client → Presentation Layer → Service Layer → Storage Layer → Database
         ↓                      ↓                ↓
      Parse Request    Validate User    Insert User
         ↓                      ↓                ↓
      Call Service    Hash Password    Commit Transaction
         ↓                      ↓                ↓
      Return Response  Return User     Return Success
```

### 4.2 房间消息发送流程

```
Client → Presentation Layer → Service Layer → Cache Layer → Storage Layer → Database
         ↓                      ↓                ↓                ↓
      Parse Request    Validate Room    Check Cache      Insert Event
         ↓                      ↓                ↓                ↓
      Call Service    Validate Member  Cache Event      Commit Transaction
         ↓                      ↓                ↓                ↓
      Return Response  Broadcast Event  Invalidate Cache Return Success
```

### 4.3 事件同步流程

```
Client → Presentation Layer → Service Layer → Cache Layer → Storage Layer
         ↓                      ↓                ↓                ↓
      Parse Request    Get Sync Token  Check Cache      Query Events
         ↓                      ↓                ↓                ↓
      Call Service    Filter Events   Update Cache    Return Events
         ↓                      ↓                ↓
      Return Response  Format Response  Set New Token   Return Success
```

---

## 五、技术选型理由

### 5.1 Rust 语言

**选择理由**：
- **内存安全**：编译时检查内存安全，避免内存泄漏和缓冲区溢出
- **并发安全**：类型系统保证线程安全，避免数据竞争
- **高性能**：零成本抽象，编译器优化，无运行时开销
- **生态丰富**：成熟的异步运行时（Tokio）、Web 框架（Axum）、数据库库（SQLx）

**优势**：
- 比 Python 性能提升 50% 以上
- 内存占用降低 40% 以上
- 并发处理能力提升 3 倍以上

### 5.2 Tokio 运行时

**选择理由**：
- **成熟稳定**：Rust 生态系统中最流行的异步运行时
- **功能完整**：支持异步 I/O、定时器、任务调度等
- **性能优秀**：基于 epoll/kqueue，高效处理并发连接
- **生态丰富**：与大多数 Rust 异步库兼容

**优势**：
- 高效的事件循环
- 优秀的任务调度
- 丰富的异步原语

### 5.3 Axum 框架

**选择理由**：
- **基于 Tokio**：与 Tokio 运行时完美集成
- **类型安全**：编译时检查路由和参数类型
- **性能优秀**：基于 Hyper，性能接近原生 HTTP
- **易于使用**：简洁的 API，快速开发

**优势**：
- 路由编译时检查
- 提取器模式简化参数处理
- 中间件系统灵活
- 支持异步处理器

### 5.4 SQLx 数据库库

**选择理由**：
- **类型安全**：编译时检查 SQL 查询
- **性能优秀**：直接使用原生 SQL，无 ORM 开销
- **异步支持**：原生支持 Tokio 异步运行时
- **功能完整**：支持连接池、事务、迁移等

**优势**：
- 编译时 SQL 验证
- 零成本抽象
- 支持复杂查询
- 连接池管理

### 5.5 PostgreSQL 数据库

**选择理由**：
- **成熟稳定**：企业级关系型数据库
- **功能完整**：支持 JSON、数组、全文搜索等
- **性能优秀**：索引优化、查询优化
- **扩展性强**：支持自定义函数、扩展

**优势**：
- ACID 事务支持
- 复杂查询能力
- JSON 支持
- 全文搜索

### 5.6 Redis 缓存

**选择理由**：
- **高性能**：内存存储，读写速度快
- **分布式**：支持集群和主从复制
- **功能完整**：支持多种数据结构
- **持久化**：支持 RDB 和 AOF 持久化

**优势**：
- 低延迟访问
- 分布式缓存
- 丰富的数据结构
- 持久化支持

### 5.7 Moka 本地缓存

**选择理由**：
- **高性能**：内存缓存，无网络开销
- **LRU 策略**：自动淘汰最少使用的数据
- **异步支持**：支持 Tokio 异步运行时
- **线程安全**：支持多线程并发访问

**优势**：
- 极低延迟
- 自动淘汰
- 线程安全
- 异步支持

---

## 六、性能优化策略

### 6.1 缓存策略

#### 6.1.1 两级缓存

- **本地缓存**：Moka，提供最快的访问速度
- **分布式缓存**：Redis，支持多实例共享

#### 6.1.2 缓存键设计

- **用户配置**：`user:config:{user_id}`
- **房间配置**：`room:config:{room_id}`
- **事件列表**：`room:events:{room_id}`
- **令牌验证**：`token:validate:{token}`

#### 6.1.3 缓存过期

- **用户配置**：5 分钟
- **房间配置**：10 分钟
- **事件列表**：1 分钟
- **令牌验证**：5 分钟

### 6.2 数据库优化

#### 6.2.1 连接池

- **连接池大小**：CPU 核心数 × 4
- **连接池预热**：启动时预先建立 min_size 个连接
- **连接池超时**：30 秒

#### 6.2.2 索引优化

- **用户表**：username, user_id
- **设备表**：user_id, device_id
- **房间表**：room_id
- **事件表**：room_id, event_id, origin_server_ts

#### 6.2.3 查询优化

- **批量操作**：减少数据库往返次数
- **分页查询**：避免一次性加载大量数据
- **索引覆盖**：查询使用索引覆盖

### 6.3 异步处理

#### 6.3.1 并发控制

- **最大并发数**：1000
- **每个连接并发数**：10
- **队列长度**：100

#### 6.3.2 任务调度

- **tokio::spawn**：并行执行独立任务
- **join!/try_join!**：组合多个 Future
- **select!**：处理多个 Future 的竞争

---

## 七、安全设计

### 7.1 认证安全

#### 7.1.1 密码哈希

- **算法**：Argon2
- **安全等级**：3
- **内存成本**：64 MB
- **时间成本**：3 次迭代

#### 7.1.2 JWT 令牌

- **算法**：HS256
- **密钥长度**：256 位
- **访问令牌有效期**：24 小时
- **刷新令牌有效期**：7 天

### 7.2 传输安全

#### 7.2.1 HTTPS

- **强制使用**：所有 API 强制使用 HTTPS
- **TLS 版本**：TLS 1.3
- **HSTS**：强制浏览器使用 HTTPS

#### 7.2.2 数据加密

- **敏感数据**：客户端使用 TLS 1.3 加密传输
- **数据库连接**：使用 SSL 连接
- **Redis 连接**：使用 SSL 连接

### 7.3 输入验证

#### 7.3.1 参数验证

- **类型检查**：所有参数进行类型检查
- **长度限制**：限制字符串长度
- **格式验证**：使用正则表达式验证格式
- **特殊字符**：转义或过滤特殊字符

#### 7.3.2 SQL 注入防护

- **参数化查询**：SQLx 使用参数化查询
- **编译时检查**：SQLx 编译时检查 SQL 语法

### 7.4 审计日志

#### 7.4.1 日志内容

- **时间戳**：操作时间
- **用户 ID**：操作用户
- **操作类型**：操作类型
- **IP 地址**：客户端 IP
- **操作结果**：成功或失败

#### 7.4.2 日志存储

- **独立存储**：审计日志独立存储
- **防篡改**：审计日志防篡改
- **定期备份**：定期备份审计日志

---

## 八、扩展性设计

### 8.1 水平扩展

#### 8.1.1 无状态设计

- **服务层**：无状态，支持水平扩展
- **缓存层**：Redis 集群，支持水平扩展
- **存储层**：PostgreSQL 主从复制，支持读写分离

#### 8.1.2 负载均衡

- **反向代理**：Nginx 负载均衡
- **健康检查**：定期健康检查
- **故障转移**：自动故障转移

### 8.2 垂直扩展

#### 8.2.1 资源优化

- **CPU**：多核 CPU 利用
- **内存**：内存优化，减少内存占用
- **磁盘**：SSD 存储，提升 I/O 性能

#### 8.2.2 配置优化

- **连接池**：调整连接池大小
- **缓存**：调整缓存大小和过期时间
- **并发**：调整并发数和队列长度

---

## 九、参考资料

- [Synapse 官方文档](https://element-hq.github.io/synapse/latest/)
- [Matrix 规范](https://spec.matrix.org/)
- [Axum 框架文档](https://docs.rs/axum/latest/axum/)
- [SQLx 文档](https://docs.rs/sqlx/latest/sqlx/)
- [Tokio 文档](https://docs.rs/tokio/latest/tokio/)

---

## 十、变更日志

| 版本 | 日期 | 变更说明 |
|------|------|----------|
| 1.0.0 | 2026-01-28 | 初始版本，定义架构设计文档 |
