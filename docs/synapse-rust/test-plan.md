# Synapse-Rust API 测试方案

本方案旨在为 Synapse-Rust 项目提供一套系统、可执行的测试流程，确保项目 API 100% 可用且符合 Matrix 协议标准及增强功能需求。

---

## 1. 测试范围
测试涵盖 `api-reference.md` 中定义的所有接口，重点包括：
- **认证与账号**：注册、登录、Token 刷新与注销。
- **房间操作**：创建、加入、邀请、消息发送、状态同步。
- **管理功能**：用户/房间运维、IP 封禁与信誉系统。
- **增强功能**：好友关系、私聊会话、语音消息。
- **端到端加密 (E2EE)**：密钥上传、申领与备份。
- **联邦通信**：跨服务器请求与数据发现。

---

## 2. 测试策略
采用 **自动化为主，手动为辅** 的分层测试策略：

### 2.1 单元与集成测试 (Rust 原生)
- 使用 `cargo test` 运行针对核心逻辑和存储层的单元测试。
- 编写集成测试，利用 `axum::serve` 启动内存服务器进行端到端流程验证。

### 2.2 接口自动化测试 (外部工具)
- 使用 Postman 或轻量级脚本（如 `curl` + `jq`）对部署后的 API 进行批量验证。
- 重点验证 JSON Schema 匹配、状态码返回及业务逻辑链路（如：注册 -> 登录 -> 创建房间 -> 发消息）。

### 2.3 安全性测试
- **权限提取器校验**：验证未携带 Token 的请求是否返回 `401 Unauthorized`。
- **角色权限校验**：验证非管理员用户访问 `/_synapse/admin/v1/` 下的接口是否返回 `403 Forbidden`。
- **越权风险校验**：验证用户 A 是否能修改或删除用户 B 的资源（如头像、私聊消息）。

---

## 3. 测试用例设计方法
每个接口至少包含以下三类用例：

| 用例类型 | 设计重点 | 示例 |
| :--- | :--- | :--- |
| **正向用例** | 验证核心功能，参数完整且合法。 | 使用合法的 username 和 password 注册成功。 |
| **边界用例** | 验证参数限制和分页边界。 | 获取用户列表时 limit 设为 1、1000 或超出范围。 |
| **异常用例** | 验证错误处理和容错能力。 | 使用已存在的用户名注册、使用过期的 Token 同步。 |

---

## 4. 测试环境配置
- **操作系统**: Linux (Ubuntu/Debian 推荐)
- **数据库**: PostgreSQL 15+ (Docker 部署)
- **运行时**: Rust 1.75+
- **配置**: 使用 `config.yaml` 配置测试数据库连接、日志等级及服务端口。

---

## 5. 测试数据需求
为了保证测试的全面性，需要在数据库中预构造以下数据：

### 5.1 基础数据
- 1 个超级管理员账户 (`@admin:server`)。
- 5 个普通活跃账户。
- 3 个被停用或封禁的账户。

### 5.2 业务数据
- 10 个公开房间，包含不同层级的成员权限。
- 5 个私有加密房间。
- 复杂的好友关系：双向好友、单向请求、黑名单。
- 媒体文件：不同格式（PNG, JPG, MP3, MP4）的上传记录。

### 5.3 异常数据
- 格式错误的 IP 封禁记录。
- 缺失关键字段的房间事件。
- 指向非存在用户的 Token 映射。

---

## 6. 测试执行流程
1. **环境准备**：启动 PostgreSQL 容器，执行 `sqlx migrate run`。
2. **数据灌入**：运行测试数据构造脚本（`setup_test_data.sql`）。
3. **自动化扫描**：运行 Rust 集成测试套件。
4. **手动抽检**：针对 UI 相关或流媒体接口进行手动 Postman 调试。
5. **缺陷记录**：在 `defect-list.md` 中记录发现的问题。
6. **回归测试**：修复后重新执行上述流程。

---

## 7. 质量标准
- **可用性**: 所有定义接口必须能返回非 500 响应。
- **安全性**: 所有管理/敏感接口必须有权限校验。
- **一致性**: 数据库状态变更必须符合事务一致性。
- **阻塞缺陷**: 0 个。
