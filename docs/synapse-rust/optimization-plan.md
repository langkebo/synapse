# Synapse-Rust 系统级优化清单

基于 `test-report.md` 及官方性能调优建议，制定以下优化方案。

| 优化维度 | 优化项 | 预期收益 | 风险 | 回滚方案 |
| :--- | :--- | :--- | :--- | :--- |
| **内存与缓存** | 增加 `cache_factors` 与 `event_cache_size` | 提高 L1/L2 缓存命中率，减少数据库 I/O 压力，降低 API 响应延迟。 | 内存占用增加，可能导致 OOM。 | 调低缓存因子，重启服务。 |
| **联邦性能** | 调整 `send_queue_limit` 与 `resolve_timeout` | 防止因单个慢速联邦节点导致的请求积压，提高跨服消息传递效率。 | 极端情况下可能导致联邦消息丢失。 | 恢复默认超时时间与队列限制。 |
| **媒体处理** | 优化 `thumbnail_sizes` 与 `max_image_pixels` | 减少不必要的缩略图生成开销，限制大图处理时的内存峰值。 | 部分旧客户端缩略图显示异常。 | 恢复标准的缩略图尺寸配置。 |
| **网络层** | Nginx HTTP/2 + TLS 1.3 + OCSP Stapling | 降低 SSL 握手延迟，提升首包响应速度。 | 部分极老版本浏览器不兼容。 | 回退到 TLS 1.2。 |
| **连接管理** | Upstream Keepalive = 32 | 减少 Nginx 与后端 Synapse 之间的 TCP 握手开销。 | 连接过多可能占用后端句柄。 | 调低 Keepalive 值。 |
| **安全与透明度** | `X-Forwarded-*` 完整链路头 | 确保后端能正确识别客户端真实 IP，便于限流与审计。 | 配置错误可能导致后端无法获取 IP。 | 检查并恢复 Nginx Header 配置。 |

## 1. 详细调优参数说明

### 1.1 Cache Factors
- **建议值**: `1.0` -> `2.0`
- **依据**: Rust 版内存管理更精细，适当增加缓存因子可显著减少数据库读压力。

### 1.2 Event Cache Size
- **建议值**: `10000`
- **依据**: 频繁访问的房间事件应尽可能驻留内存，减少磁盘 I/O。

### 1.3 Federation Resolve Timeout
- **建议值**: `15s`
- **依据**: 联邦节点 DNS 或连接响应超过 15s 通常意味着节点不可用，应快速失败避免阻塞 worker。

### 1.4 Max Image Pixels
- **建议值**: `32M`
- **依据**: 限制上传图片的分辨率，防止恶意大图导致的内存溢出攻击。
