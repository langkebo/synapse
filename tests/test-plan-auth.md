# Synapse Rust 认证模块测试方案

> **版本**: 1.0.0  
> **创建日期**: 2026-02-02  
> **测试模块**: 认证模块 (13个API)  
> **测试目标**: 验证所有认证相关API的功能正确性

---

## 一、测试环境准备

### 1.1 环境要求

| 组件 | 版本/配置 | 说明 |
|------|-----------|------|
| 操作系统 | Linux | 推荐Ubuntu 20.04+ |
| Rust | 1.93.0 | 编译环境 |
| PostgreSQL | 15+ | 数据库 |
| curl | 7.68+ | HTTP测试工具 |
| jq | 1.6+ | JSON处理工具 |

### 1.2 服务器配置

```yaml
# config.yaml
server:
  name: "localhost"
  host: "0.0.0.0"
  port: 8008

database:
  url: "postgres://synapse:synapse@localhost:5432/synapse_test"
  pool_size: 10

jwt:
  secret: "test_secret_key_for_development_only"
  expiry: 86400

auth:
  token_expiry: 86400
  refresh_token_expiry: 604800
  password_min_length: 8
  require_strong_password: false
```

### 1.3 测试数据准备

| 测试用户 | 用户名 | 密码 | 是否管理员 |
|---------|--------|------|-----------|
| user1 | testuser1 | TestPassword123 | 否 |
| user2 | testuser2 | TestPassword456 | 否 |
| admin1 | adminuser | AdminPassword789 | 是 |

---

## 二、测试策略

### 2.1 测试分类

| 测试类型 | 数量 | 说明 |
|---------|------|------|
| 正向测试 | 13 | 验证API正常工作 |
| 负向测试 | 10+ | 验证错误处理 |
| 边界测试 | 5+ | 验证参数边界 |
| 安全测试 | 3+ | 验证认证和授权 |

### 2.2 测试顺序

```
1. 获取客户端版本 (无需认证)
2. 检查用户名可用性 (无需认证)
3. 用户注册 (无需认证)
4. 用户登录 (无需认证)
5. 获取当前用户信息 (需要认证)
6. 获取用户资料 (需要认证)
7. 更新显示名称 (需要认证)
8. 更新头像 (需要认证)
9. 修改密码 (需要认证)
10. 刷新令牌 (无需认证)
11. 登出 (需要认证)
12. 全部登出 (需要认证)
13. 停用账户 (需要认证)
```

### 2.3 依赖关系

```
注册 → 登录 → 获取令牌 → 认证API → 登出/停用
```

---

## 三、API测试用例

### 3.1 获取客户端版本

**API**: `GET /_matrix/client/versions`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 1.1 | 正常请求 | 返回支持的版本列表 |
| 1.2 | 重复请求 | 返回相同结果 |
| 1.3 | 并发请求 | 所有请求成功 |

**验证点**:
- HTTP状态码: 200
- 响应包含 `versions` 数组
- 响应包含 `unstable_features` 对象
- 版本列表包含 r0.0.1 到 r0.6.0

---

### 3.2 检查用户名可用性

**API**: `GET /_matrix/client/r0/register/available?username={username}`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 2.1 | 检查不存在的用户名 | available: true |
| 2.2 | 检查已存在的用户名 | available: false |
| 2.3 | 空用户名 | 400错误 |
| 2.4 | 特殊字符用户名 | 400错误或可用 |
| 2.5 | 超长用户名 | 400错误 |

**验证点**:
- HTTP状态码: 200
- 响应包含 `available` 布尔值
- 响应包含 `username` 字符串

---

### 3.3 用户注册

**API**: `POST /_matrix/client/r0/register`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 3.1 | 正常注册 | 返回user_id和access_token |
| 3.2 | 重复注册相同用户名 | 400错误 |
| 3.3 | 密码太短 | 400错误 |
| 3.4 | 缺少必填字段 | 400错误 |
| 3.5 | 注册管理员账户 | 返回admin: true |

**验证点**:
- HTTP状态码: 200
- 响应包含 `user_id` (格式: @username:server.com)
- 响应包含 `access_token`
- 响应包含 `device_id`
- 数据库中创建用户记录

---

### 3.4 用户登录

**API**: `POST /_matrix/client/r0/login`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 4.1 | 正常登录 | 返回access_token和refresh_token |
| 4.2 | 错误密码 | 401错误 |
| 4.3 | 不存在的用户 | 401错误 |
| 4.4 | 缺少密码 | 400错误 |
| 4.5 | 指定device_id | 返回指定device_id |

**验证点**:
- HTTP状态码: 200
- 响应包含 `access_token`
- 响应包含 `refresh_token`
- 响应包含 `expires_in`
- 响应包含 `user_id`
- 响应包含 `device_id`
- 响应包含 `well_known.m.homeserver.base_url`

---

### 3.5 获取当前用户信息

**API**: `GET /_matrix/client/r0/account/whoami`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 5.1 | 正常请求 | 返回用户信息 |
| 5.2 | 无效令牌 | 401错误 |
| 5.3 | 过期令牌 | 401错误 |
| 5.4 | 缺少令牌 | 401错误 |

**验证点**:
- HTTP状态码: 200
- 响应包含 `user_id`
- 响应包含 `displayname` (如果设置了)
- 响应包含 `avatar_url` (如果设置了)
- 响应包含 `admin` 布尔值

---

### 3.6 获取用户资料

**API**: `GET /_matrix/client/r0/account/profile/{user_id}`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 6.1 | 获取自己的资料 | 返回完整资料 |
| 6.2 | 获取其他用户资料 | 返回公开资料 |
| 6.3 | 不存在的用户 | 404错误 |
| 6.4 | 无效user_id格式 | 400错误 |

**验证点**:
- HTTP状态码: 200
- 响应包含 `displayname`
- 响应包含 `avatar_url`

---

### 3.7 更新显示名称

**API**: `PUT /_matrix/client/r0/account/profile/{user_id}/displayname`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 7.1 | 更新自己的显示名 | 成功更新 |
| 7.2 | 更新为空字符串 | 成功更新为空 |
| 7.3 | 更新其他用户显示名(非管理员) | 403错误 |
| 7.4 | 无效令牌 | 401错误 |
| 7.5 | 超长显示名 | 400错误或成功 |

**验证点**:
- HTTP状态码: 200
- 响应为空对象 `{}`
- 数据库中displayname已更新

---

### 3.8 更新头像

**API**: `PUT /_matrix/client/r0/account/profile/{user_id}/avatar_url`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 8.1 | 更新自己的头像 | 成功更新 |
| 8.2 | 更新为空字符串 | 成功清除头像 |
| 8.3 | 更新其他用户头像(非管理员) | 403错误 |
| 8.4 | 无效mxc URL | 400错误 |
| 8.5 | 无效令牌 | 401错误 |

**验证点**:
- HTTP状态码: 200
- 响应为空对象 `{}`
- 数据库中avatar_url已更新

---

### 3.9 修改密码

**API**: `POST /_matrix/client/r0/account/password`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 9.1 | 正常修改密码 | 成功修改 |
| 9.2 | 新密码太短 | 400错误 |
| 9.3 | 缺少new_password | 400错误 |
| 9.4 | 无效令牌 | 401错误 |
| 9.5 | 修改后用新密码登录 | 成功登录 |

**验证点**:
- HTTP状态码: 200
- 响应为空对象 `{}`
- 数据库中密码哈希已更新
- 旧密码无法登录

---

### 3.10 刷新令牌

**API**: `POST /_matrix/client/r0/refresh`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 10.1 | 正常刷新令牌 | 返回新令牌 |
| 10.2 | 无效refresh_token | 401错误 |
| 10.3 | 过期refresh_token | 401错误 |
| 10.4 | 缺少refresh_token | 400错误 |
| 10.5 | 刷新后旧令牌失效 | 旧令牌返回401 |

**验证点**:
- HTTP状态码: 200
- 响应包含 `access_token`
- 响应包含 `refresh_token`
- 响应包含 `expires_in`
- 响应包含 `device_id`
- 新access_token有效

---

### 3.11 登出

**API**: `POST /_matrix/client/r0/logout`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 11.1 | 正常登出 | 成功登出 |
| 11.2 | 无效令牌 | 401错误 |
| 11.3 | 缺少令牌 | 401错误 |
| 11.4 | 登出后令牌失效 | 令牌返回401 |
| 11.5 | 重复登出 | 成功 |

**验证点**:
- HTTP状态码: 200
- 响应为空对象 `{}`
- access_token已失效
- 数据库中令牌标记为无效

---

### 3.12 全部登出

**API**: `POST /_matrix/client/r0/logout/all`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 12.1 | 正常全部登出 | 所有设备登出 |
| 12.2 | 无效令牌 | 401错误 |
| 12.3 | 缺少令牌 | 401错误 |
| 12.4 | 多设备登录后全部登出 | 所有设备令牌失效 |

**验证点**:
- HTTP状态码: 200
- 响应为空对象 `{}`
- 用户所有access_token已失效
- 数据库中所有令牌标记为无效

---

### 3.13 停用账户

**API**: `POST /_matrix/client/r0/account/deactivate`

| 测试ID | 测试场景 | 预期结果 |
|--------|---------|----------|
| 13.1 | 正常停用账户 | 成功停用 |
| 13.2 | 无效令牌 | 401错误 |
| 13.3 | 缺少令牌 | 401错误 |
| 13.4 | 停用后无法登录 | 401错误 |
| 13.5 | 重复停用 | 成功 |

**验证点**:
- HTTP状态码: 200
- 响应包含 `id_server_unbind_result`
- 用户账户已标记为停用
- 用户无法登录

---

## 四、测试执行流程

### 4.1 准备阶段

```bash
# 1. 启动数据库
docker-compose up -d postgres

# 2. 运行数据库迁移
cargo run --bin synapse-rust migrate

# 3. 启动服务器
cargo run --release

# 4. 等待服务器启动
sleep 5
```

### 4.2 执行阶段

```bash
# 运行测试脚本
./tests/test-auth-module.sh

# 或使用curl直接测试
./tests/test-auth-manual.sh
```

### 4.3 清理阶段

```bash
# 1. 停止服务器
pkill synapse-rust

# 2. 清理测试数据
docker-compose down -v

# 3. 查看测试报告
cat tests/results/auth-test-results.json
```

---

## 五、测试结果记录

### 5.1 结果格式

```json
{
  "test_suite": "认证模块测试",
  "test_date": "2026-02-02T10:00:00Z",
  "test_environment": {
    "server_version": "0.1.0",
    "database": "PostgreSQL 15",
    "test_duration_seconds": 120
  },
  "summary": {
    "total_tests": 65,
    "passed": 63,
    "failed": 2,
    "skipped": 0,
    "success_rate": "96.9%"
  },
  "results": [
    {
      "test_id": "1.1",
      "api": "GET /_matrix/client/versions",
      "test_name": "正常请求",
      "status": "passed",
      "duration_ms": 45,
      "http_status": 200,
      "response": {
        "versions": ["r0.0.1", "r0.1.0"],
        "unstable_features": {}
      },
      "error": null
    }
  ]
}
```

### 5.2 成功标准

| 指标 | 目标值 |
|------|--------|
| 总体通过率 | ≥ 95% |
| 关键API通过率 | 100% |
| 响应时间 | < 500ms (P95) |
| 错误处理 | 所有错误返回正确状态码 |

### 5.3 失败处理

1. **记录失败详情**:
   - 测试ID和名称
   - 失败原因
   - 错误消息
   - 响应内容

2. **分类失败原因**:
   - 功能性错误
   - 性能问题
   - 数据不一致
   - 安全问题

3. **生成修复建议**:
   - 代码修复建议
   - 配置调整建议
   - 文档更新建议

---

## 六、测试报告模板

### 6.1 执行摘要

```
测试套件: 认证模块测试
执行时间: 2026-02-02 10:00:00 UTC
测试环境: 开发环境
测试人员: QA Team

总测试数: 65
通过: 63
失败: 2
跳过: 0
通过率: 96.9%

总体状态: ✅ 通过
```

### 6.2 详细结果

| API | 测试数 | 通过 | 失败 | 通过率 |
|-----|--------|------|------|--------|
| 获取客户端版本 | 3 | 3 | 0 | 100% |
| 检查用户名可用性 | 5 | 5 | 0 | 100% |
| 用户注册 | 5 | 5 | 0 | 100% |
| 用户登录 | 5 | 5 | 0 | 100% |
| 获取当前用户信息 | 4 | 4 | 0 | 100% |
| 获取用户资料 | 4 | 4 | 0 | 100% |
| 更新显示名称 | 5 | 5 | 0 | 100% |
| 更新头像 | 5 | 5 | 0 | 100% |
| 修改密码 | 5 | 4 | 1 | 80% |
| 刷新令牌 | 5 | 5 | 0 | 100% |
| 登出 | 5 | 5 | 0 | 100% |
| 全部登出 | 4 | 4 | 0 | 100% |
| 停用账户 | 5 | 4 | 1 | 80% |

### 6.3 失败用例详情

| 测试ID | API | 测试名称 | 失败原因 | 严重程度 |
|--------|-----|---------|---------|----------|
| 9.5 | 修改密码 | 修改后用新密码登录 | 数据库更新延迟 | 中 |
| 13.4 | 停用账户 | 停用后无法登录 | 令牌缓存未清理 | 中 |

### 6.4 性能指标

| API | 平均响应时间 | P50 | P95 | P99 |
|-----|-------------|-----|-----|-----|
| 获取客户端版本 | 45ms | 42ms | 48ms | 55ms |
| 用户登录 | 120ms | 115ms | 130ms | 150ms |
| 用户注册 | 180ms | 170ms | 195ms | 220ms |
| 获取当前用户信息 | 35ms | 33ms | 38ms | 42ms |

### 6.5 建议和改进

1. **性能优化**:
   - 优化用户注册响应时间
   - 添加数据库索引

2. **功能改进**:
   - 修复令牌缓存清理问题
   - 添加密码强度验证

3. **文档更新**:
   - 更新API响应时间说明
   - 添加错误码详细说明

---

## 七、测试脚本说明

### 7.1 自动化测试脚本

- `test-auth-module.sh`: 完整的自动化测试脚本
- `test-auth-manual.sh`: 手动测试脚本（用于调试）

### 7.2 辅助工具

- `jq`: JSON解析和格式化
- `curl`: HTTP请求工具
- `python3`: 结果生成脚本

### 7.3 配置文件

- `test-config.sh`: 测试环境配置
- `test-data.sh`: 测试数据定义

---

## 八、测试注意事项

### 8.1 数据隔离

- 使用独立的测试数据库
- 每次测试前清理数据
- 避免与开发/生产环境冲突

### 8.2 并发测试

- 控制并发请求数量
- 避免资源竞争
- 监控服务器负载

### 8.3 错误处理

- 记录所有错误响应
- 验证错误状态码
- 检查错误消息格式

### 8.4 安全测试

- 验证认证机制
- 测试SQL注入防护
- 检查XSS防护

---

## 九、测试验收标准

### 9.1 功能验收

- ✅ 所有正向测试通过
- ✅ 所有错误处理正确
- ✅ 数据一致性验证通过

### 9.2 性能验收

- ✅ P95响应时间 < 500ms
- ✅ 无内存泄漏
- ✅ 并发测试稳定

### 9.3 安全验收

- ✅ 认证机制有效
- ✅ 无SQL注入漏洞
- ✅ 无XSS漏洞

---

## 十、附录

### 10.1 术语表

| 术语 | 说明 |
|------|------|
| access_token | 访问令牌，用于API认证 |
| refresh_token | 刷新令牌，用于获取新的access_token |
| user_id | Matrix用户ID，格式: @username:server.com |
| device_id | 设备ID，标识用户设备 |
| mxc:// | Matrix Content URI，用于媒体资源 |

### 10.2 参考文档

- [Matrix Client-Server API](https://spec.matrix.org/v1.2/client-server-api/)
- [Synapse Rust API Reference](./api-reference.md)
- [项目规则文档](../.trae/rules/project_rules.md)

### 10.3 联系方式

- 测试负责人: QA Team
- 技术支持: Dev Team
- 问题反馈: GitHub Issues
