# Synapse Rust API 全面测试计划

## 一、项目分析总结

### API端点统计
- **总计**：140个API端点（分布在9个主要模块）
- **核心客户端API**：47个
- **管理API**：14个
- **联邦API**：22个
- **语音消息API**：7个
- **好友系统API**：14个
- **E2EE API**：6个
- **媒体API**：8个
- **私聊API**：13个
- **密钥备份API**：9个

### 现有文档状态
- 已有141个API的初步测试结果
- 测试状态分布：✅ OK（通过）、⚠️ WARN（警告）、❌ FAIL（失败）

### 认证机制
- JWT Token认证，有效期24小时
- Bearer Token方式
- 支持用户认证和管理员认证

## 二、执行步骤

### 阶段1：环境准备
1. 启动Synapse Rust服务器
2. 验证服务器健康状态
3. 准备测试数据库连接

### 阶段2：测试账号准备
1. 注册测试用户账号（普通用户）
2. 注册测试管理员账号
3. 获取并保存访问令牌（Access Token）
4. 验证令牌有效性

### 阶段3：API全面测试
按模块顺序测试所有140个API端点：

**3.1 基础端点（无需认证）**
- GET `/` - 根路径
- GET `/health` - 健康检查
- GET `/_matrix/client/versions` - 客户端版本
- GET `/_matrix/federation/v1/version` - 联邦版本

**3.2 认证相关API**
- POST `/_matrix/client/r0/register` - 用户注册
- POST `/_matrix/client/r0/login` - 用户登录
- POST `/_matrix/client/r0/logout` - 用户登出
- POST `/_matrix/client/r0/logout/all` - 全部登出
- POST `/_matrix/client/r0/refresh` - 刷新令牌

**3.3 用户账户API（需要认证）**
- GET `/_matrix/client/r0/account/whoami` - 获取当前用户信息
- GET/PUT `/_matrix/client/r0/account/profile/{user_id}/*` - 用户资料管理
- POST `/_matrix/client/r0/account/password` - 修改密码
- POST `/_matrix/client/r0/account/deactivate` - 停用账户

**3.4 设备管理API**
- GET `/_matrix/client/r0/devices` - 获取设备列表
- GET/PUT/DELETE `/_matrix/client/r0/devices/{device_id}` - 设备管理

**3.5 房间管理API**
- POST `/_matrix/client/r0/createRoom` - 创建房间
- POST `/_matrix/client/r0/rooms/{room_id}/join` - 加入房间
- POST `/_matrix/client/r0/rooms/{room_id}/leave` - 离开房间
- POST `/_matrix/client/r0/rooms/{room_id}/invite` - 邀请用户
- GET `/_matrix/client/r0/rooms/{room_id}/members` - 获取成员列表
- GET `/_matrix/client/r0/rooms/{room_id}/messages` - 获取消息
- POST `/_matrix/client/r0/rooms/{room_id}/send/{event_type}` - 发送消息

**3.6 同步与消息API**
- GET `/_matrix/client/r0/sync` - 同步事件

**3.7 在线状态API**
- GET/PUT `/_matrix/client/r0/presence/{user_id}/status` - 在线状态

**3.8 房间状态API**
- GET `/_matrix/client/r0/rooms/{room_id}/state/*` - 房间状态管理

**3.9 管理API（需要管理员权限）**
- GET `/_synapse/admin/v1/server_version` - 服务器版本
- GET `/_synapse/admin/v1/users` - 用户列表
- GET `/_synapse/admin/v1/rooms` - 房间列表
- 安全管理相关API

**3.10 联邦API**
- 公开端点：服务器密钥、版本查询
- 受保护端点：事务发送、加入/离开等

**3.11 增强功能API**
- 好友系统API（14个）
- 语音消息API（7个）
- 私聊API（13个）
- E2EE API（6个）
- 媒体API（8个）
- 密钥备份API（9个）

### 阶段4：测试记录
对每个API记录以下信息：
- 完整请求URL
- 请求头（包括认证信息）
- 请求体（JSON格式）
- 查询参数
- 响应状态码
- 响应体
- 响应时间
- 测试结果（通过/失败/警告）
- 失败原因（如适用）

### 阶段5：文档更新
更新 `/home/hula/synapse_rust/docs/synapse-rust/api-reference.md` 文件：
1. 完善API清单，补充详细信息
2. 添加每个API的测试请求示例
3. 添加每个API的测试响应示例
4. 标注测试状态和失败原因
5. 提供测试数据（测试用户ID、Token等）

## 三、测试策略

### 测试精度
- 每个API至少测试一次
- 对失败的API进行多次重试
- 检查请求参数配置、认证信息有效性、请求格式规范性
- 多次调整测试方法后仍失败，才判定为功能未实现或存在缺陷

### 测试优先级
1. **高优先级**：核心功能API（认证、用户管理、房间管理、消息）
2. **中优先级**：增强功能API（好友、语音、私聊）
3. **低优先级**：管理API和联邦API

### 错误处理
- 记录所有错误响应
- 分析错误原因（参数错误、认证失败、权限不足、功能未实现等）
- 对可修复的错误提供修复建议

## 四、预期输出

完成测试后，api-reference.md文档将包含：
1. 完整的140个API端点清单
2. 每个API的详细信息（方法、路径、参数、认证、响应格式）
3. 每个API的测试请求示例（完整curl命令）
4. 每个API的测试响应示例（状态码、响应体）
5. 测试状态标注（✅通过、⚠️警告、❌失败）
6. 失败原因分析和修复建议
7. 测试数据（测试用户、Token、房间ID等）

## 五、时间估算

- 环境准备：5分钟
- 测试账号准备：5分钟
- API测试：约60-90分钟（每个API约30-45秒）
- 文档更新：30分钟
- **总计**：约100-130分钟

## 六、注意事项

1. 测试过程中优先注重测试精度，可适当延长测试时间
2. 遇到测试失败时，首先全面检查测试方法的正确性
3. 多次调整测试方法后仍失败，方可判定为API功能未实现或存在缺陷
4. 所有测试数据（Token、用户ID等）将记录在文档中，方便后续复现