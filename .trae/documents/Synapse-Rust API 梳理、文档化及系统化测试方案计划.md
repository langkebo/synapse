# Synapse-Rust API 梳理与测试方案计划

## 1. API 梳理与文档编制
我们将对项目中所有模块的 API 进行深度扫描，并按照模块化原则整理到 `docs/synapse-rust/api-reference.md` 中。
- **梳理范围**：
  - **核心客户端 API** (`mod.rs`)：注册、登录、同步、房间管理、设备管理、在线状态。
  - **管理接口** (`admin.rs`)：用户与房间运维、安全审计（IP 封禁/信誉）、系统状态。
  - **增强功能 API**：好友系统 (`friend.rs`)、端到端加密 (`e2ee_routes.rs` / `key_backup.rs`)、多媒体/语音 (`media.rs` / `voice.rs`)、私聊增强 (`private_chat.rs`)。
  - **联邦接口** (`federation.rs`)：服务器间通信与发现。
- **文档内容**：详细列出每个接口的 HTTP 方法、完整路径、认证要求（匿名/用户/管理员）、请求参数说明（JSON Body/Query/Path）及预期响应。

## 2. API 测试方案制定
制定系统化的测试方案，确保 100% 可用性。
- **测试维度**：
  - **功能测试**：验证业务逻辑正确性（正向/反向路径）。
  - **安全性测试**：验证角色提取器（`AdminUser`/`AuthenticatedUser`）是否能有效阻断未授权请求。
  - **边界与异常测试**：输入超长字符串、空字段、非法 JSON 格式、过期 Token 等。
  - **性能与兼容性**：关注 `/sync` 等高频接口的响应时间及对 Matrix 标准协议的兼容程度。

## 3. 测试数据构造与环境配置
在 PostgreSQL 数据库中构造覆盖全场景的测试数据。
- **数据覆盖**：
  - **用户层**：超级管理员、普通活跃用户、被封禁用户。
  - **业务层**：各种可见性（Public/Private）的房间、复杂的好友关系网、多样的 E2EE 密钥状态。
  - **安全层**：IP 封禁记录、异常登录日志、低信誉 IP 数据。
- **一致性保证**：确保外键关联正确，模拟真实运行环境。

## 4. 测试执行与报告输出
- **自动化执行**：利用 `cargo test` 运行集成测试，并编写辅助测试脚本进行批量请求验证。
- **手动验证**：针对复杂的联邦发现和媒体流传输进行针对性校验。
- **交付物**：
  - 完善的 `api-reference.md` 文档。
  - 自动化测试用例集。
  - 详细的测试报告与缺陷清单（Bug List）。

**请确认是否开始执行？**