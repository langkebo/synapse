# PostgreSQL 配置文件
# 针对Synapse Matrix服务器和好友功能优化
# 适用于1核2GB服务器环境

#------------------------------------------------------------------------------
# 文件位置
#------------------------------------------------------------------------------

# 数据目录
#data_directory = '/var/lib/postgresql/data'

# HBA配置文件
#hba_file = '/var/lib/postgresql/data/pg_hba.conf'

# 标识文件
#ident_file = '/var/lib/postgresql/data/pg_ident.conf'

# 外部PID文件
#external_pid_file = ''

#------------------------------------------------------------------------------
# 连接和认证
#------------------------------------------------------------------------------

# 监听地址
listen_addresses = '*'

# 端口
port = 5432

# 最大连接数（针对1核2GB优化）
max_connections = 30

# 为超级用户保留的连接数
superuser_reserved_connections = 3

# Unix域套接字目录
#unix_socket_directories = '/var/run/postgresql'

# Unix域套接字组
#unix_socket_group = ''

# Unix域套接字权限
#unix_socket_permissions = 0777

# Bonjour服务名
#bonjour = off
#bonjour_name = ''

# TCP Keepalives
tcp_keepalives_idle = 600
tcp_keepalives_interval = 30
tcp_keepalives_count = 3

# TCP用户超时
#tcp_user_timeout = 0

# 客户端连接默认值
#client_connection_check_interval = 0

#------------------------------------------------------------------------------
# 资源使用（内存）
#------------------------------------------------------------------------------

# 共享缓冲区（设置为可用内存的20%，约400MB）
shared_buffers = 400MB

# 巨大页面
#huge_pages = try

# 临时缓冲区
temp_buffers = 32MB

# 最大预处理事务数
max_prepared_transactions = 0

# 工作内存（每个排序操作）
work_mem = 8MB

# 哈希表内存
hash_mem_multiplier = 1.0

# 维护工作内存
maintenance_work_mem = 64MB

# 自动清理最大工作内存
autovacuum_work_mem = -1

# 逻辑解码工作内存
logical_decoding_work_mem = 64MB

# 最大栈深度
max_stack_depth = 2MB

# 共享内存类型
shared_memory_type = mmap

# 动态共享内存类型
dynamic_shared_memory_type = posix

#------------------------------------------------------------------------------
# 资源使用（磁盘）
#------------------------------------------------------------------------------

# 临时文件限制
temp_file_limit = -1

# 最大文件数
max_files_per_process = 1000

#------------------------------------------------------------------------------
# 资源使用（内核资源）
#------------------------------------------------------------------------------

# 最大锁数
max_locks_per_transaction = 64

# 最大谓词锁数
max_pred_locks_per_transaction = 64

# 最大谓词锁页数
max_pred_locks_per_relation = -2

# 最大谓词锁页数（每页）
max_pred_locks_per_page = 2

#------------------------------------------------------------------------------
# 预写日志
#------------------------------------------------------------------------------

# WAL级别
wal_level = replica

# 同步提交
synchronous_commit = on

# WAL同步方法
wal_sync_method = fsync

# 全页写入
full_page_writes = on

# WAL压缩
wal_compression = off

# WAL初始化零填充
wal_init_zero = on

# WAL回收
wal_recycle = on

# WAL缓冲区
wal_buffers = 16MB

# WAL写入延迟
wal_writer_delay = 200ms

# WAL写入刷新后
wal_writer_flush_after = 1MB

# 提交延迟
commit_delay = 0

# 提交兄弟
commit_siblings = 5

# 检查点段数
max_wal_size = 1GB

# 最小WAL大小
min_wal_size = 80MB

# 检查点完成目标
checkpoint_completion_target = 0.9

# 检查点刷新后
checkpoint_flush_after = 256kB

# 检查点警告
checkpoint_warning = 30s

# 检查点超时
checkpoint_timeout = 5min

# 归档模式
archive_mode = off

# 归档命令
#archive_command = ''

# 归档超时
#archive_timeout = 0

# 归档库
#archive_library = ''

#------------------------------------------------------------------------------
# 复制
#------------------------------------------------------------------------------

# 最大WAL发送者
max_wal_senders = 10

# 最大复制槽
max_replication_slots = 10

# WAL保持大小
wal_keep_size = 0

# 最大槽WAL保持大小
max_slot_wal_keep_size = -1

# WAL发送者超时
wal_sender_timeout = 60s

# 跟踪提交时间戳
track_commit_timestamp = off

#------------------------------------------------------------------------------
# 备用服务器
#------------------------------------------------------------------------------

# 主服务器信息
#primary_conninfo = ''

# 主服务器槽名
#primary_slot_name = ''

# 提升触发文件
#promote_trigger_file = ''

# 热备用
hot_standby = on

# 最大热备用延迟
max_standby_archive_delay = 30s
max_standby_streaming_delay = 30s

# WAL接收者状态间隔
wal_receiver_status_interval = 10s

# WAL接收者超时
wal_receiver_timeout = 60s

# WAL检索重试间隔
wal_retrieve_retry_interval = 5s

# 恢复最小应用延迟
recovery_min_apply_delay = 0

#------------------------------------------------------------------------------
# 查询调优
#------------------------------------------------------------------------------

# 启用位图扫描
enable_bitmapscan = on

# 启用哈希聚合
enable_hashagg = on

# 启用哈希连接
enable_hashjoin = on

# 启用索引扫描
enable_indexscan = on

# 启用仅索引扫描
enable_indexonlyscan = on

# 启用材料
enable_material = on

# 启用合并连接
enable_mergejoin = on

# 启用嵌套循环
enable_nestloop = on

# 启用并行聚合
enable_parallel_append = on

# 启用并行哈希
enable_parallel_hash = on

# 启用分区修剪
enable_partition_pruning = on

# 启用分区连接
enable_partitionwise_join = off

# 启用分区聚合
enable_partitionwise_aggregate = off

# 启用顺序扫描
enable_seqscan = on

# 启用排序
enable_sort = on

# 启用TID扫描
enable_tidscan = on

#------------------------------------------------------------------------------
# 查询调优（成本）
#------------------------------------------------------------------------------

# 顺序页面成本
seq_page_cost = 1.0

# 随机页面成本（SSD优化）
random_page_cost = 1.1

# CPU元组成本
cpu_tuple_cost = 0.01

# CPU索引元组成本
cpu_index_tuple_cost = 0.005

# CPU操作符成本
cpu_operator_cost = 0.0025

# 并行元组成本
parallel_tuple_cost = 0.1

# 并行设置成本
parallel_setup_cost = 1000.0

# JIT成本
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# 最小并行表扫描大小
min_parallel_table_scan_size = 8MB

# 最小并行索引扫描大小
min_parallel_index_scan_size = 512kB

# 有效缓存大小
effective_cache_size = 800MB

#------------------------------------------------------------------------------
# 查询调优（其他）
#------------------------------------------------------------------------------

# 默认统计目标
default_statistics_target = 100

# 约束排除
constraint_exclusion = partition

# 游标元组分数
cursor_tuple_fraction = 0.1

# 从折叠限制
from_collapse_limit = 8

# 连接折叠限制
join_collapse_limit = 8

# 强制并行模式
force_parallel_mode = off

# JIT
jit = on

# 最大并行工作者数（针对1核CPU）
max_parallel_workers_per_gather = 1
max_parallel_maintenance_workers = 1
max_parallel_workers = 1

# 旧快照阈值
old_snapshot_threshold = -1

#------------------------------------------------------------------------------
# 错误报告和日志
#------------------------------------------------------------------------------

# 日志目标
log_destination = 'stderr'

# 日志收集器
logging_collector = off

# 日志目录
#log_directory = 'log'

# 日志文件名模式
#log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'

# 日志文件模式
#log_file_mode = 0600

# 日志轮转年龄
#log_rotation_age = 1d

# 日志轮转大小
#log_rotation_size = 10MB

# 日志截断重启
#log_truncate_on_rotation = off

# 系统日志设施
#syslog_facility = 'LOCAL0'

# 系统日志标识
#syslog_ident = 'postgres'

# 系统日志序列号
#syslog_sequence_numbers = on

# 系统日志分割消息
#syslog_split_messages = on

# 事件日志
#event_source = 'PostgreSQL'

# 客户端最小消息
client_min_messages = notice

# 日志最小消息
log_min_messages = warning

# 日志最小错误语句
log_min_error_statement = error

# 日志最小持续时间
log_min_duration_statement = 1000

# 日志最小持续时间示例
log_min_duration_sample = -1

# 日志语句示例率
log_statement_sample_rate = 1.0

# 日志事务示例率
log_transaction_sample_rate = 0.0

# 调试打印解析
#debug_print_parse = off

# 调试打印重写
#debug_print_rewritten = off

# 调试打印计划
#debug_print_plan = off

# 调试漂亮打印
#debug_pretty_print = on

# 日志自动解释
#log_autovacuum_min_duration = -1

# 日志检查点
log_checkpoints = on

# 日志连接
log_connections = off

# 日志断开连接
log_disconnections = off

# 日志持续时间
log_duration = off

# 日志错误详细程度
log_error_verbosity = default

# 日志主机名
log_hostname = off

# 日志行前缀
log_line_prefix = '%t [%p]: [%l-1] user=%u,db=%d,app=%a,client=%h '

# 日志锁等待
log_lock_waits = on

# 日志参数最大长度
log_parameter_max_length = -1

# 日志参数最大长度错误
log_parameter_max_length_on_error = 0

# 日志解析器统计
#log_parser_stats = off

# 日志规划器统计
#log_planner_stats = off

# 日志执行器统计
#log_executor_stats = off

# 日志语句统计
#log_statement_stats = off

# 日志重用连接
log_replication_commands = off

# 日志语句
log_statement = 'none'

# 日志临时文件
log_temp_files = 0

# 日志时区
log_timezone = 'Asia/Shanghai'

#------------------------------------------------------------------------------
# 进程标题
#------------------------------------------------------------------------------

cluster_name = 'synapse-postgres'
update_process_title = on

#------------------------------------------------------------------------------
# 统计
#------------------------------------------------------------------------------

# 跟踪活动
track_activities = on

# 跟踪活动查询大小
track_activity_query_size = 1024

# 跟踪计数
track_counts = on

# 跟踪I/O时间
track_io_timing = on

# 跟踪WAL I/O时间
track_wal_io_timing = off

# 跟踪函数
track_functions = none

# 统计临时目录
stats_temp_directory = 'pg_stat_tmp'

#------------------------------------------------------------------------------
# 自动清理
#------------------------------------------------------------------------------

# 自动清理
autovacuum = on

# 自动清理最大工作者
autovacuum_max_workers = 1

# 自动清理轻推间隔
autovacuum_naptime = 1min

# 自动清理清理阈值
autovacuum_vacuum_threshold = 50

# 自动清理分析阈值
autovacuum_analyze_threshold = 50

# 自动清理清理比例因子
autovacuum_vacuum_scale_factor = 0.2

# 自动清理分析比例因子
autovacuum_analyze_scale_factor = 0.1

# 自动清理冻结最大年龄
autovacuum_freeze_max_age = 200000000

# 自动清理多事务冻结最大年龄
autovacuum_multixact_freeze_max_age = 400000000

# 自动清理清理成本延迟
autovacuum_vacuum_cost_delay = 2ms

# 自动清理清理成本限制
autovacuum_vacuum_cost_limit = 200

#------------------------------------------------------------------------------
# 客户端连接默认值
#------------------------------------------------------------------------------

# 搜索路径
#search_path = '"$user", public'

# 默认表空间
#default_tablespace = ''

# 临时表空间
#temp_tablespaces = ''

# 检查函数体
check_function_bodies = on

# 默认事务隔离
#default_transaction_isolation = 'read committed'

# 默认事务只读
#default_transaction_read_only = off

# 默认事务可延迟
#default_transaction_deferrable = off

# 会话复制角色
#session_replication_role = 'origin'

# 语句超时
statement_timeout = 0

# 锁超时
lock_timeout = 0

# 空闲会话超时
idle_in_transaction_session_timeout = 0

# 空闲会话超时
idle_session_timeout = 0

# 清理成本延迟
vacuum_cost_delay = 0

# 清理成本页面命中
vacuum_cost_page_hit = 1

# 清理成本页面未命中
vacuum_cost_page_miss = 10

# 清理成本页面脏
vacuum_cost_page_dirty = 20

# 清理成本限制
vacuum_cost_limit = 200

# 清理冻结最小年龄
vacuum_freeze_min_age = 50000000

# 清理冻结表年龄
vacuum_freeze_table_age = 150000000

# 清理多事务冻结最小年龄
vacuum_multixact_freeze_min_age = 5000000

# 清理多事务冻结表年龄
vacuum_multixact_freeze_table_age = 150000000

# 清理失败安全年龄
vacuum_failsafe_age = 1600000000

# 清理多事务失败安全年龄
vacuum_multixact_failsafe_age = 1600000000

# 字节顺序标记
bytea_output = 'hex'

# XML二进制
#xmlbinary = 'base64'

# XML选项
#xmloption = 'content'

# GIN模糊搜索限制
gin_fuzzy_search_limit = 0

# GIN待处理列表限制
gin_pending_list_limit = 4MB

#------------------------------------------------------------------------------
# 区域设置和格式
#------------------------------------------------------------------------------

# 日期样式
datestyle = 'iso, mdy'

# 间隔样式
intervalstyle = 'postgres'

# 时区
timezone = 'Asia/Shanghai'

# 时区缩写
#timezone_abbreviations = 'Default'

# 额外浮点数字
extra_float_digits = 1

#------------------------------------------------------------------------------
# 其他默认值
#------------------------------------------------------------------------------

# 动态库路径
#dynamic_library_path = '$libdir'

# 本地预加载库
#local_preload_libraries = ''

# 会话预加载库
#session_preload_libraries = ''

# 共享预加载库
#shared_preload_libraries = ''

# JIT提供者
#jit_provider = 'llvmjit'

#------------------------------------------------------------------------------
# 锁管理
#------------------------------------------------------------------------------

# 死锁超时
deadlock_timeout = 1s

# 最大锁每事务
max_locks_per_transaction = 64

# 最大谓词锁每事务
max_pred_locks_per_transaction = 64

# 最大谓词锁每关系
max_pred_locks_per_relation = -2

# 最大谓词锁每页
max_pred_locks_per_page = 2

#------------------------------------------------------------------------------
# 版本和平台兼容性
#------------------------------------------------------------------------------

# 数组空值
array_nulls = on

# 反斜杠引用
backslash_quote = safe_encoding

# 默认WITH OIDS
default_with_oids = off

# 转义字符串警告
escape_string_warning = on

# Lo兼容特权
lo_compat_privileges = off

# 操作符优先级警告
operator_precedence_warning = off

# 引用所有标识符
quote_all_identifiers = off

# SQL继承
sql_inheritance = on

# 标准符合字符串
standard_conforming_strings = on

# 同步扫描
synchronize_seqscans = on

# 转换空字符串为空
transform_null_equals = off

#------------------------------------------------------------------------------
# 错误处理
#------------------------------------------------------------------------------

# 退出错误
exit_on_error = off

# 重启错误
restart_after_crash = on

# 数据校验和
data_checksums = off

#------------------------------------------------------------------------------
# Synapse专用优化
#------------------------------------------------------------------------------

# 针对Matrix Synapse的特定优化

# 增加统计目标以改善查询计划
default_statistics_target = 1000

# 启用JIT编译以加速复杂查询
jit = on
jit_above_cost = 100000
jit_inline_above_cost = 500000
jit_optimize_above_cost = 500000

# 优化检查点设置
checkpoint_completion_target = 0.9
checkpoint_timeout = 15min
max_wal_size = 2GB
min_wal_size = 1GB

# 优化自动清理
autovacuum_vacuum_scale_factor = 0.1
autovacuum_analyze_scale_factor = 0.05
autovacuum_vacuum_cost_limit = 1000
autovacuum_vacuum_cost_delay = 10ms

# 启用并行查询
max_parallel_workers_per_gather = 2
max_parallel_workers = 2
max_parallel_maintenance_workers = 1

# 优化连接池
max_connections = 50

# 内存设置
shared_buffers = 512MB
effective_cache_size = 1GB
work_mem = 16MB
maintenance_work_mem = 128MB

# 日志设置
log_min_duration_statement = 1000
log_checkpoints = on
log_connections = off
log_disconnections = off
log_lock_waits = on
log_temp_files = 0

# 时区设置
timezone = 'Asia/Shanghai'
log_timezone = 'Asia/Shanghai'

#------------------------------------------------------------------------------
# 扩展配置
#------------------------------------------------------------------------------

# 共享预加载库（根据需要启用扩展）
# shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements配置
# pg_stat_statements.max = 10000
# pg_stat_statements.track = all
# pg_stat_statements.track_utility = off
# pg_stat_statements.save = on

#------------------------------------------------------------------------------
# 自定义变量
#------------------------------------------------------------------------------

# 自定义变量可以在这里设置
# custom.variable_name = 'value'

#------------------------------------------------------------------------------
# 包含其他配置文件
#------------------------------------------------------------------------------

# 包含目录
# include_dir = 'conf.d'

# 包含文件
# include = 'special.conf'

# 包含如果存在
# include_if_exists = 'exists.conf'

#------------------------------------------------------------------------------
# 配置文件结束
#------------------------------------------------------------------------------