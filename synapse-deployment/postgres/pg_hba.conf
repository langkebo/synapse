# PostgreSQL Client Authentication Configuration File
# ===================================================
#
# 此文件控制PostgreSQL服务器的客户端认证
# 针对Synapse Matrix服务器和好友功能优化
#
# 文件格式:
# TYPE  DATABASE        USER            ADDRESS                 METHOD
#
# TYPE: 连接类型
#   "local" - Unix域套接字连接
#   "host"  - TCP/IP连接（SSL和非SSL）
#   "hostssl" - 仅SSL TCP/IP连接
#   "hostnossl" - 仅非SSL TCP/IP连接
#
# DATABASE: 数据库名称
#   "all" - 所有数据库
#   "sameuser" - 与用户名相同的数据库
#   "samerole" - 与角色名相同的数据库
#   "replication" - 复制连接
#   数据库名称或逗号分隔的列表
#
# USER: 用户名
#   "all" - 所有用户
#   用户名或逗号分隔的列表
#   "+role" - 角色成员
#
# ADDRESS: 客户端地址
#   "all" - 所有地址
#   "samehost" - 本机地址
#   "samenet" - 同一子网
#   IP地址/掩码
#   主机名
#
# METHOD: 认证方法
#   "trust" - 无条件信任
#   "reject" - 无条件拒绝
#   "md5" - MD5密码认证
#   "password" - 明文密码认证
#   "scram-sha-256" - SCRAM-SHA-256认证
#   "gss" - GSSAPI认证
#   "sspi" - SSPI认证
#   "ident" - Ident认证
#   "peer" - Peer认证
#   "pam" - PAM认证
#   "ldap" - LDAP认证
#   "radius" - RADIUS认证
#   "cert" - SSL客户端证书认证

# ============================================================================
# 本地连接配置
# ============================================================================

# 本地Unix域套接字连接
# 允许本地用户通过Unix套接字连接
local   all             postgres                                peer
local   all             all                                     peer

# ============================================================================
# IPv4本地连接
# ============================================================================

# 本地回环地址连接
# 允许本地应用程序连接
host    all             postgres        127.0.0.1/32            scram-sha-256
host    all             all             127.0.0.1/32            scram-sha-256

# ============================================================================
# IPv6本地连接
# ============================================================================

# IPv6本地回环地址连接
host    all             postgres        ::1/128                 scram-sha-256
host    all             all             ::1/128                 scram-sha-256

# ============================================================================
# Synapse Matrix服务器连接配置
# ============================================================================

# Synapse主数据库连接
# 允许Synapse用户连接到synapse数据库
host    synapse         synapse_user    127.0.0.1/32            scram-sha-256
host    synapse         synapse_user    ::1/128                 scram-sha-256

# 好友功能数据库连接
# 允许好友功能用户连接
host    synapse         friends_user    127.0.0.1/32            scram-sha-256
host    synapse         friends_user    ::1/128                 scram-sha-256

# Docker网络连接
# 允许Docker容器网络连接
host    synapse         synapse_user    172.16.0.0/12           scram-sha-256
host    synapse         synapse_user    192.168.0.0/16          scram-sha-256
host    synapse         friends_user    172.16.0.0/12           scram-sha-256
host    synapse         friends_user    192.168.0.0/16          scram-sha-256

# ============================================================================
# 复制连接配置
# ============================================================================

# 本地复制连接
local   replication     postgres                                peer
host    replication     postgres        127.0.0.1/32            scram-sha-256
host    replication     postgres        ::1/128                 scram-sha-256

# 远程复制连接（如果需要）
# host    replication     replicator      192.168.1.0/24          scram-sha-256

# ============================================================================
# 监控和管理连接
# ============================================================================

# 监控用户连接
# 允许监控工具连接
host    all             monitor_user    127.0.0.1/32            scram-sha-256
host    all             monitor_user    ::1/128                 scram-sha-256
host    all             monitor_user    172.16.0.0/12           scram-sha-256
host    all             monitor_user    192.168.0.0/16          scram-sha-256

# 备份用户连接
host    all             backup_user     127.0.0.1/32            scram-sha-256
host    all             backup_user     ::1/128                 scram-sha-256

# ============================================================================
# 开发和测试连接（生产环境中应该注释掉）
# ============================================================================

# 开发环境连接
# 注意：生产环境中应该删除或注释这些规则
# host    all             dev_user        192.168.1.0/24          md5
# host    all             test_user       192.168.1.0/24          md5

# ============================================================================
# 安全配置
# ============================================================================

# 拒绝所有其他连接
# 这是一个安全措施，拒绝所有未明确允许的连接
# host    all             all             0.0.0.0/0               reject
# host    all             all             ::/0                    reject

# ============================================================================
# SSL连接配置（可选）
# ============================================================================

# 如果启用了SSL，可以使用以下配置
# 强制SSL连接
# hostssl synapse         synapse_user    0.0.0.0/0               scram-sha-256
# hostssl synapse         friends_user    0.0.0.0/0               scram-sha-256

# 禁止非SSL连接
# hostnossl all           all             0.0.0.0/0               reject

# ============================================================================
# 特殊用途连接
# ============================================================================

# 只读用户连接
# 允许只读用户连接到所有数据库
host    all             readonly_user   127.0.0.1/32            scram-sha-256
host    all             readonly_user   ::1/128                 scram-sha-256
host    all             readonly_user   172.16.0.0/12           scram-sha-256
host    all             readonly_user   192.168.0.0/16          scram-sha-256

# 应用程序用户连接
# 允许应用程序用户连接
host    synapse         app_user        127.0.0.1/32            scram-sha-256
host    synapse         app_user        ::1/128                 scram-sha-256
host    synapse         app_user        172.16.0.0/12           scram-sha-256
host    synapse         app_user        192.168.0.0/16          scram-sha-256

# ============================================================================
# 网络安全配置
# ============================================================================

# 内网连接
# 允许内网地址连接（根据实际网络环境调整）
# host    synapse         synapse_user    10.0.0.0/8              scram-sha-256
# host    synapse         friends_user    10.0.0.0/8              scram-sha-256

# VPN连接
# 如果使用VPN，可以配置VPN网段
# host    all             all             10.8.0.0/24             scram-sha-256

# ============================================================================
# 日志和审计配置
# ============================================================================

# 注意：连接日志在postgresql.conf中配置
# log_connections = on
# log_disconnections = on
# log_hostname = on

# ============================================================================
# 性能优化配置
# ============================================================================

# 连接池配置
# 建议使用pgbouncer等连接池工具
# 在postgresql.conf中设置：
# max_connections = 50
# superuser_reserved_connections = 3

# ============================================================================
# 故障排除
# ============================================================================

# 如果遇到连接问题，可以临时启用以下配置进行调试：
# host    all             all             127.0.0.1/32            trust
# 注意：调试完成后必须删除trust方法的配置

# ============================================================================
# 配置文件结束
# ============================================================================

# 重要提醒：
# 1. 修改此文件后需要重新加载PostgreSQL配置：
#    sudo systemctl reload postgresql
#    或者：SELECT pg_reload_conf();
#
# 2. 生产环境中应该：
#    - 使用强密码
#    - 启用SSL连接
#    - 限制网络访问
#    - 定期审查访问日志
#    - 使用最小权限原则
#
# 3. 安全检查清单：
#    - 删除不必要的trust方法
#    - 使用scram-sha-256而不是md5
#    - 限制网络访问范围
#    - 启用连接日志
#    - 定期更新密码
#    - 监控异常连接

# 中文化说明：
# 此配置文件已针对中国用户进行了优化，包括：
# - 中文注释和说明
# - 适合中国网络环境的配置
# - 安全最佳实践
# - 性能优化建议