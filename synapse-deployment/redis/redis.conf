# Redis 配置文件
# 针对Synapse Matrix服务器和好友功能优化
# 适用于1核2GB服务器环境

################################## 网络配置 ##################################

# 绑定地址
bind 0.0.0.0

# 端口
port 6379

# TCP监听队列长度
tcp-backlog 511

# 超时设置（0表示禁用）
timeout 300

# TCP keepalive
tcp-keepalive 300

################################# 通用配置 #################################

# 守护进程模式
daemonize no

# 进程ID文件
pidfile /var/run/redis_6379.pid

# 日志级别
loglevel notice

# 日志文件
logfile ""

# 数据库数量
databases 16

# 启动时显示logo
always-show-logo no

# 设置服务器详细程度
set-proc-title yes
proc-title-template "{title} {listen-addr} {server-mode}"

################################ 快照配置 ################################

# 快照保存条件（针对低配置优化）
save 900 1
save 300 10
save 60 10000

# 快照失败时停止写入
stop-writes-on-bgsave-error yes

# 压缩RDB文件
rdbcompression yes

# RDB文件校验
rdbchecksum yes

# RDB文件名
dbfilename dump.rdb

# RDB和AOF文件目录
dir /data

################################# 复制配置 #################################

# 主从复制配置（单机部署暂时禁用）
# replicaof <masterip> <masterport>

# 主服务器密码
# masterauth <master-password>

# 从服务器密码
# requirepass <password>

# 从服务器只读
replica-read-only yes

# 复制超时
repl-timeout 60

# 禁用TCP_NODELAY
repl-disable-tcp-nodelay no

# 复制积压缓冲区大小（针对低内存优化）
repl-backlog-size 512kb

# 复制积压缓冲区TTL
repl-backlog-ttl 3600

# 从服务器优先级
replica-priority 100

################################## 安全配置 ##################################

# 访问密码（生产环境请设置强密码）
# requirepass your_strong_password_here

# 重命名危险命令
rename-command FLUSHDB ""
rename-command FLUSHALL ""
rename-command KEYS ""
rename-command CONFIG "CONFIG_b840fc02d524045429941cc15f59e41cb7be6c52"
rename-command DEBUG ""
rename-command EVAL ""
rename-command SHUTDOWN "SHUTDOWN_b840fc02d524045429941cc15f59e41cb7be6c52"

# 保护模式
protected-mode yes

################################### 客户端配置 ###################################

# 最大客户端连接数（针对低配置优化）
maxclients 50

################################## 内存管理 ##################################

# 最大内存使用（设置为可用内存的60%，约1.2GB中的800MB）
maxmemory 800mb

# 内存淘汰策略（适合缓存场景）
maxmemory-policy allkeys-lru

# 内存采样数量
maxmemory-samples 5

# 从服务器忽略最大内存限制
replica-ignore-maxmemory yes

# 活跃重新哈希
activerehashing yes

# 客户端输出缓冲区限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 128mb 32mb 60
client-output-buffer-limit pubsub 16mb 4mb 60

# 客户端查询缓冲区限制
client-query-buffer-limit 1gb

# 协议最大批量请求大小
proto-max-bulk-len 512mb

################################ 惰性释放 ################################

# 惰性删除
lazyfree-lazy-eviction no
lazyfree-lazy-expire no
lazyfree-lazy-server-del no
replica-lazy-flush no

# 惰性用户删除
lazyfree-lazy-user-del no

################################ 线程I/O配置 ################################

# I/O线程数（针对1核CPU优化）
io-threads 1
io-threads-do-reads no

################################## 慢日志 ##################################

# 慢查询日志时间阈值（微秒）
slowlog-log-slower-than 10000

# 慢查询日志最大长度
slowlog-max-len 128

################################ 延迟监控 ################################

# 延迟监控阈值（毫秒）
latency-monitor-threshold 100

############################# 事件通知 ##############################

# 键空间通知（根据需要启用）
notify-keyspace-events ""

############################### 高级配置 ###############################

# 哈希表最大ziplist条目数
hash-max-ziplist-entries 512
hash-max-ziplist-value 64

# 列表最大ziplist大小
list-max-ziplist-size -2

# 列表压缩深度
list-compress-depth 0

# 集合最大intset条目数
set-max-intset-entries 512

# 有序集合最大ziplist条目数
zset-max-ziplist-entries 128
zset-max-ziplist-value 64

# HyperLogLog稀疏表示字节限制
hll-sparse-max-bytes 3000

# 流宏节点最大字节数
stream-node-max-bytes 4096

# 流宏节点最大条目数
stream-node-max-entries 100

# 活跃重新哈希每100毫秒使用的CPU时间
activerehashing yes

# 客户端输出缓冲区硬限制和软限制
client-output-buffer-limit normal 0 0 0
client-output-buffer-limit replica 256mb 64mb 60
client-output-buffer-limit pubsub 32mb 8mb 60

# 频率（降低以减少CPU使用）
hz 5

# 启用动态频率
dynamic-hz yes

# AOF重写增量fsync
aof-rewrite-incremental-fsync yes

# RDB保存增量fsync
rdb-save-incremental-fsync yes

# LFU日志因子
lfu-log-factor 10

# LFU衰减时间
lfu-decay-time 1

########################### 模块配置 ###########################

# 加载模块
# loadmodule /path/to/my_module.so

########################### 集群配置 ###########################

# 启用集群模式
# cluster-enabled yes

# 集群配置文件
# cluster-config-file nodes-6379.conf

# 集群节点超时
# cluster-node-timeout 15000

# 集群故障转移投票有效期
# cluster-replica-validity-factor 10

# 集群迁移屏障
# cluster-migration-barrier 1

# 集群要求完整覆盖
# cluster-require-full-coverage yes

# 集群副本无故障转移
# cluster-replica-no-failover no

# 集群允许读取命令
# cluster-allow-reads-when-down no

########################## 慢日志 ##########################

# 慢日志记录时间（微秒）
slowlog-log-slower-than 10000

# 慢日志最大记录数
slowlog-max-len 128

########################## 延迟监控 ##########################

# 延迟监控阈值（毫秒）
latency-monitor-threshold 100

######################### 事件通知 #########################

# 键空间事件通知
# notify-keyspace-events Ex

############################### 本地配置 ###############################

# 本地化设置
locale-collate ""

############################### 调试配置 ###############################

# 看门狗周期
# watchdog-period 0

# 启用调试
# enable-debug-command no

# 启用模块调试
# enable-module-command no

############################### Synapse专用配置 ###############################

# 为Synapse Matrix服务器优化的配置

# 数据库0：会话存储
# 数据库1：速率限制
# 数据库2：缓存
# 数据库3：好友功能缓存
# 数据库4：媒体缓存
# 数据库5：房间状态缓存
# 数据库6：用户状态缓存
# 数据库7：事件缓存
# 数据库8：联邦缓存
# 数据库9：推送通知缓存
# 数据库10：搜索缓存
# 数据库11：预览缓存
# 数据库12：临时数据
# 数据库13：统计数据
# 数据库14：监控数据
# 数据库15：备用

############################### 性能优化 ###############################

# 针对1核2GB服务器的性能优化

# 禁用透明大页
# echo never > /sys/kernel/mm/transparent_hugepage/enabled

# 设置内核参数
# vm.overcommit_memory = 1
# net.core.somaxconn = 65535
# net.ipv4.tcp_max_syn_backlog = 65535

# Redis特定优化
# 减少内存碎片
activedefrag yes
active-defrag-ignore-bytes 100mb
active-defrag-threshold-lower 10
active-defrag-threshold-upper 100
active-defrag-cycle-min 1
active-defrag-cycle-max 25
active-defrag-max-scan-fields 1000

# JEMalloc配置
# export MALLOC_CONF="dirty_decay_ms:1000,muzzy_decay_ms:1000"

############################### 监控配置 ###############################

# 启用INFO命令的所有部分
# info all

# 启用统计信息
# config set save ""

############################### 备份配置 ###############################

# 自动备份脚本路径
# /usr/local/bin/redis-backup.sh

############################### 日志配置 ###############################

# 系统日志设施
# syslog-enabled no
# syslog-ident redis
# syslog-facility local0

############################### 中文化配置 ###############################

# 时区设置（在Docker环境变量中设置）
# TZ=Asia/Shanghai

# 字符编码（UTF-8）
# LC_ALL=zh_CN.UTF-8

############################### 好友功能专用配置 ###############################

# 好友关系缓存TTL（秒）
# 通过应用程序设置：EXPIRE friends:user:123 3600

# 好友请求缓存TTL（秒）
# 通过应用程序设置：EXPIRE friend_requests:user:123 1800

# 在线状态缓存TTL（秒）
# 通过应用程序设置：EXPIRE presence:user:123 300

# 搜索结果缓存TTL（秒）
# 通过应用程序设置：EXPIRE search:query:hash 600

############################### 安全加固 ###############################

# 禁用危险命令（已在上面配置）
# 设置强密码（生产环境必须）
# 配置防火墙规则
# 启用TLS（如果需要）
# tls-port 6380
# tls-cert-file /path/to/redis.crt
# tls-key-file /path/to/redis.key
# tls-ca-cert-file /path/to/ca.crt

############################### 故障排除 ###############################

# 启用详细日志（调试时使用）
# loglevel debug

# 启用慢日志
# slowlog-log-slower-than 1000

# 启用延迟监控
# latency-monitor-threshold 10

# 内存使用报告
# memory usage
# memory stats
# memory doctor

############################### 结束配置 ###############################

# Redis配置文件结束
# 重启Redis服务以应用配置更改
# docker restart redis

# 验证配置
# redis-cli CONFIG GET "*"
# redis-cli INFO
# redis-cli MEMORY USAGE

# 监控命令
# redis-cli MONITOR
# redis-cli --latency
# redis-cli --stat

# 性能测试
# redis-benchmark -h localhost -p 6379 -c 50 -n 10000